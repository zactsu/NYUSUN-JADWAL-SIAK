<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nyusun Jadwal by Lookman</title>
    <style>
        :root {
            --primary-color: #4A4E69; --secondary-color: #9A8C98; --background-color: #F2E9E4;
            --card-bg-color: #FFFFFF; --text-color: #22223B; --border-color: #C9ADA7; --header-bg: #6D6A75;
            --danger-color: #c94f4f; --success-color: #2a9d8f;
        }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--background-color); color: var(--text-color); margin: 0; padding: 0; }
        .page-header { text-align: center; padding: 20px; font-size: 2em; color: var(--primary-color); }
        .container { max-width: 1200px; margin: auto; padding: 0 20px 20px 20px; }
        .page-footer { text-align: center; padding: 20px; margin-top: 40px; font-size: 0.9em; color: var(--secondary-color); border-top: 1px solid var(--border-color); }
        .tab-nav { display: flex; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; margin-bottom: 20px; }
        .tab-button { flex: 1; padding: 15px; border: none; background-color: var(--card-bg-color); color: var(--primary-color); font-size: 1em; font-weight: bold; cursor: pointer; transition: background-color 0.3s; border-right: 1px solid var(--border-color); }
        .tab-button:last-child { border-right: none; }
        .tab-button.active { background-color: var(--primary-color); color: white; }
        .tab-button:not(.active):hover { background-color: #e9e2de; }
        .view-container { display: none; }
        .view-container.active { display: block; }
        .pilih-matkul-layout { display: flex; gap: 20px; align-items: flex-start; }
        #left-panel { flex: 2; }
        #right-panel { flex: 1; position: sticky; top: 20px; }
        h2 { font-size: 1.5em; text-align: left; border: none; padding: 0; margin: 0; }
        .summary-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--border-color); padding-bottom: 10px; }
        #reset-button { background-color: transparent; color: var(--danger-color); border: 1px solid var(--danger-color); border-radius: 5px; padding: 5px 10px; font-size: 0.8em; font-weight: bold; cursor: pointer; }
        #reset-button:hover { background-color: var(--danger-color); color: white; }
        .course-card { background-color: var(--card-bg-color); border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 15px; padding: 15px; }
        .course-header { font-size: 1.1em; font-weight: bold; margin-bottom: 5px; }
        .course-subheader { font-size: 0.85em; color: #555; margin-bottom: 10px; }
        .class-item { padding: 10px 0; border-top: 1px dashed var(--border-color); display: flex; align-items: flex-start; }
        .class-item:first-of-type { border-top: none; }
        .class-info { margin-left: 10px; flex-grow: 1; }
        .class-info strong { display: block; }
        .class-info .details { font-size: 0.9em; color: #555; display: block; margin-top: 4px; line-height: 1.6; }
        #selected-classes-panel { background-color: var(--card-bg-color); border-radius: 8px; padding: 15px; border: 1px solid var(--border-color); }
        #selected-list-header { display: grid; grid-template-columns: 3fr 2fr 1fr; padding-bottom: 10px; padding-top: 5px; border-bottom: 1px solid var(--border-color); font-weight: bold; font-size: 0.9em; }
        #selected-list-content { margin-top: 10px; max-height: 50vh; overflow-y: auto; }
        .selected-item { display: grid; grid-template-columns: 3fr 2fr 1fr; padding: 12px 4px; font-size: 0.9em; border-bottom: 1px dashed var(--border-color); align-items: center; }
        .selected-item span:last-child { text-align: center; }
        .selected-item:last-child { border-bottom: none; }
        #selected-list-footer { display: flex; justify-content: space-between; padding: 15px; margin: 15px -15px -15px -15px; background-color: #333; color: white; border-bottom-left-radius: 8px; border-bottom-right-radius: 8px; font-weight: bold; }
        .list-table { width: 100%; border-collapse: collapse; background-color: var(--card-bg-color); border-radius: 8px; overflow: hidden; }
        .list-table th, .list-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .list-table th { background-color: var(--header-bg); color: white; font-size: 0.9em; text-transform: uppercase; }
        .list-table tfoot td { font-weight: bold; font-size: 1.1em; }
        .list-table td { font-size: 0.95em; line-height: 1.5; }
        #timetable { display: grid; grid-template-columns: 60px repeat(6, 1fr); grid-template-rows: 40px repeat(24, 30px); background-color: var(--card-bg-color); border-radius: 8px; border: 1px solid var(--border-color); }
        .grid-header { background-color: var(--header-bg); color: white; font-weight: bold; display: flex; align-items: center; justify-content: center; font-size: 0.9em; border-right: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); }
        .grid-header:last-child { border-right: none; }
        .time-slot { font-size: 0.8em; font-weight: bold; background-color: var(--header-bg); color: white; display: flex; align-items: center; justify-content: center; border-right: 1px solid var(--border-color); border-bottom: 1px dotted var(--border-color); }
        .time-separator { grid-column: 2 / 8; border-bottom: 1px dotted var(--border-color); z-index: 1; }
        .schedule-block { background-color: #a99ca1; color: white; border-radius: 4px; padding: 5px; font-size: 0.8em; overflow: hidden; z-index: 10; }
        .block-time { font-weight: bold; font-size: 0.9em; margin-bottom: 3px; }
        .block-classname { margin-bottom: 3px; }
        .block-room { font-size: 0.9em; opacity: 0.9; }

        /* --- CSS BARU: Custom Modal Styling --- */
        #modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none; /* Sembunyi secara default */
            align-items: center; justify-content: center;
            z-index: 1000;
        }
        #modal {
            background-color: var(--card-bg-color);
            padding: 25px; border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%; max-width: 400px;
            text-align: center;
        }
        #modal-title { font-size: 1.4em; font-weight: bold; color: var(--primary-color); margin-bottom: 10px; }
        #modal-message { font-size: 1em; color: var(--text-color); margin-bottom: 20px; line-height: 1.5; }
        #modal-footer { display: flex; justify-content: center; gap: 10px; }
        .modal-button {
            padding: 10px 20px; border-radius: 5px; border: none;
            font-weight: bold; cursor: pointer; transition: opacity 0.2s;
        }
        .modal-button:hover { opacity: 0.8; }
        #modal-btn-confirm { background-color: var(--danger-color); color: white; }
        #modal-btn-ok { background-color: var(--primary-color); color: white; }
        #modal-btn-cancel { background-color: #ccc; color: #333; }
    </style>
</head>
<body>

    <div id="modal-overlay">
        <div id="modal">
            <div id="modal-title">Judul Notifikasi</div>
            <div id="modal-message">Isi pesan notifikasi.</div>
            <div id="modal-footer">
                <button id="modal-btn-confirm" class="modal-button">Ya, Hapus</button>
                <button id="modal-btn-cancel" class="modal-button">Batal</button>
                <button id="modal-btn-ok" class="modal-button">OK</button>
            </div>
        </div>
    </div>

    <header class="page-header">Nyusun Jadwal by Lookman</header>

    <div class="container">
        <div class="tab-nav">
            <button id="btn-pilih-view" class="tab-button active">Pilih Matkul</button>
            <button id="btn-list-view" class="tab-button">List Matkul</button>
            <button id="btn-calendar-view" class="tab-button">Kalender Matkul</button>
        </div>
        <div id="pilih-view" class="view-container active">
            <div class="pilih-matkul-layout">
                <div id="left-panel"><div id="course-list"><p>Memuat data mata kuliah...</p></div></div>
                <div id="right-panel">
                    <div id="selected-classes-panel">
                        <div class="summary-header"><h2>Kelas Pilihan</h2><button id="reset-button">Reset</button></div>
                        <div id="selected-list-header"><span>Kelas</span><span>Waktu</span><span>SKS</span></div>
                        <div id="selected-list-content"></div>
                        <div id="selected-list-footer"><span>Total SKS</span><span id="summary-sks-total">0</span></div>
                    </div>
                </div>
            </div>
        </div>
        <div id="list-view" class="view-container">
            <table class="list-table">
                <thead><tr><th>Nama Kelas</th><th>Waktu</th><th>Ruang</th><th>Dosen</th><th>SKS</th></tr></thead>
                <tbody id="list-view-body"></tbody>
                <tfoot><tr><td colspan="4">Total SKS</td><td id="list-sks-total">0</td></tr></tfoot>
            </table>
        </div>
        <div id="calendar-view" class="view-container">
            <div id="timetable"></div>
        </div>
    </div>
    
    <footer class="page-footer">Made by Lookman EE'24 with Gemini</footer>

<script>
document.addEventListener('DOMContentLoaded', () => {
    let courseData = [];
    let selectedClasses = JSON.parse(localStorage.getItem('jadwalPilihan')) || [];

    const allViews = document.querySelectorAll('.view-container');
    const allButtons = document.querySelectorAll('.tab-button');
    const courseListContainer = document.getElementById('course-list');
    const summaryContent = document.getElementById('selected-list-content');
    const summarySksTotal = document.getElementById('summary-sks-total');
    const resetButton = document.getElementById('reset-button');
    const listViewBody = document.getElementById('list-view-body');
    const listSksTotal = document.getElementById('list-sks-total');
    const timetableElement = document.getElementById('timetable');

    // --- LOGIKA BARU: Custom Modal Elements ---
    const modalOverlay = document.getElementById('modal-overlay');
    const modalTitle = document.getElementById('modal-title');
    const modalMessage = document.getElementById('modal-message');
    const btnConfirm = document.getElementById('modal-btn-confirm');
    const btnCancel = document.getElementById('modal-btn-cancel');
    const btnOk = document.getElementById('modal-btn-ok');

    // --- LOGIKA BARU: Fungsi Custom Modal ---
    function showModal(title, message, type = 'alert') {
        return new Promise(resolve => {
            modalTitle.textContent = title;
            modalMessage.innerHTML = message; // Pakai innerHTML agar bisa render <br>

            if (type === 'confirm') {
                btnConfirm.style.display = 'inline-block';
                btnCancel.style.display = 'inline-block';
                btnOk.style.display = 'none';

                btnConfirm.onclick = () => { resolve(true); hideModal(); };
                btnCancel.onclick = () => { resolve(false); hideModal(); };
            } else { // type 'alert'
                btnConfirm.style.display = 'none';
                btnCancel.style.display = 'none';
                btnOk.style.display = 'inline-block';
                btnOk.onclick = () => { resolve(true); hideModal(); };
            }
            modalOverlay.style.display = 'flex';
        });
    }

    function hideModal() {
        modalOverlay.style.display = 'none';
    }

    allButtons.forEach(button => { /* ... (logika tab tidak berubah) ... */ });
    resetButton.addEventListener('click', async () => { // Jadikan async untuk menunggu promise
        if (selectedClasses.length > 0) {
            // --- PERUBAHAN: Ganti confirm() dengan showModal ---
            const confirmed = await showModal('Reset Pilihan?', 'Anda yakin ingin mereset semua jadwal yang telah dipilih?', 'confirm');
            if (confirmed) {
                selectedClasses = [];
                updateAllUI();
                document.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => { cb.checked = false; });
            }
        }
    });
    
    function timeToMinutes(timeStr) { /* ... (tidak berubah) ... */ }
    function detectConflict(newClass, existingSchedule) { /* ... (tidak berubah) ... */ }

    function handleClassSelection(event) {
        const checkbox = event.target;
        const classId = checkbox.dataset.classId;
        const courseId = checkbox.dataset.courseId;
        const course = courseData.find(c => c.kode_mk === courseId);
        const selectedClassObj = { ...course.kelas.find(k => k.nama_kelas === classId) };
        selectedClassObj.sks = course.sks;
        selectedClassObj.nama_mk = course.nama_mk;
        selectedClassObj.kode_mk = course.kode_mk;
        selectedClassObj.id_unik = `${courseId}-${classId}`;

        const isCurrentlyChecked = selectedClasses.some(c => c.id_unik === selectedClassObj.id_unik);

        if (checkbox.checked && !isCurrentlyChecked) {
            const sameCourseConflict = selectedClasses.find(c => c.kode_mk === selectedClassObj.kode_mk);
            if (sameCourseConflict) {
                const indexToRemove = selectedClasses.findIndex(c => c.id_unik === sameCourseConflict.id_unik);
                selectedClasses.splice(indexToRemove, 1);
                document.getElementById(sameCourseConflict.id_unik).checked = false;
            }

            const timeConflict = detectConflict(selectedClassObj, selectedClasses);
            if (timeConflict) {
                // --- PERUBAHAN: Ganti alert() dengan showModal ---
                showModal('Jadwal Tabrakan!', `Pilihan Anda bertabrakan dengan:<br><b>${timeConflict.nama_mk} (${timeConflict.nama_kelas})</b>`);
                checkbox.checked = false;
                if(sameCourseConflict) {
                    selectedClasses.push(sameCourseConflict);
                    document.getElementById(sameCourseConflict.id_unik).checked = true;
                }
                return;
            }
            selectedClasses.push(selectedClassObj);
        } else if (!checkbox.checked && isCurrentlyChecked) {
            const indexToRemove = selectedClasses.findIndex(c => c.id_unik === selectedClassObj.id_unik);
            if(indexToRemove > -1) selectedClasses.splice(indexToRemove, 1);
        }
        updateAllUI();
    }
    
    function updateAllUI() { /* ... (tidak berubah) ... */ }
    function renderSelectedClassesSummary(totalSKS) { /* ... (tidak berubah) ... */ }
    function renderCourseList() { /* ... (tidak berubah) ... */ }
    function renderListView(totalSKS) { /* ... (tidak berubah) ... */ }
    function renderCalendarView() { /* ... (tidak berubah) ... */ }
    
    // Blok kode di bawah ini disingkat agar tidak terlalu panjang, isinya sama persis
    // ... (Semua fungsi lain yang tidak berubah, seperti render, fetch, dll.) ...

    // Salin-tempel semua fungsi yang tidak berubah dari kode sebelumnya ke sini
    allButtons.forEach(button => {
        button.addEventListener('click', () => {
            const targetViewId = button.id.replace('btn-', '');
            allButtons.forEach(btn => btn.classList.remove('active'));
            allViews.forEach(view => view.classList.remove('active'));
            button.classList.add('active');
            document.getElementById(targetViewId).classList.add('active');
        });
    });
    function timeToMinutes(timeStr) {
        const formattedTime = timeStr.replace('.', ':');
        const [hours, minutes] = formattedTime.split(':').map(Number);
        return hours * 60 + minutes;
    }
    function detectConflict(newClass, existingSchedule) {
        for (const scheduleStr of newClass.jadwal) {
            const [hari, waktu] = scheduleStr.split(', ');
            const [mulaiStr, selesaiStr] = waktu.split('-');
            const newStart = timeToMinutes(mulaiStr);
            const newEnd = timeToMinutes(selesaiStr);
            for (const existingClass of existingSchedule) {
                for (const existingScheduleStr of existingClass.jadwal) {
                    const [existingHari, existingWaktu] = existingScheduleStr.split(', ');
                    if (hari === existingHari) {
                        const [existingMulaiStr, existingSelesaiStr] = existingWaktu.split('-');
                        const existingStart = timeToMinutes(existingMulaiStr);
                        const existingEnd = timeToMinutes(existingSelesaiStr);
                        if (newStart < existingEnd && existingStart < newEnd) return existingClass;
                    }
                }
            }
        }
        return null;
    }
    function updateAllUI() {
        localStorage.setItem('jadwalPilihan', JSON.stringify(selectedClasses));
        const totalSKS = selectedClasses.reduce((sum, cls) => sum + (cls.sks || 0), 0);
        renderSelectedClassesSummary(totalSKS);
        renderListView(totalSKS);
        renderCalendarView();
    }
    function renderSelectedClassesSummary(totalSKS) {
        summaryContent.innerHTML = '';
        selectedClasses.forEach(cls => {
            const item = document.createElement('div');
            item.className = 'selected-item';
            item.innerHTML = `<span>${cls.nama_kelas}</span><span>${cls.jadwal.join('<br>')}</span><span>${cls.sks}</span>`;
            summaryContent.appendChild(item);
        });
        summarySksTotal.textContent = totalSKS;
    }
    function renderCourseList() {
        let html = '';
        const selectedIds = new Set(selectedClasses.map(c => c.id_unik));
        courseData.forEach(course => {
            html += `<div class="course-card"><div class="course-header">${course.nama_mk} (${course.sks} SKS)</div><div class="course-subheader">Kode: ${course.kode_mk} | Term: ${course.term}</div>`;
            course.kelas.forEach(cls => {
                const fullId = `${course.kode_mk}-${cls.nama_kelas}`;
                const isChecked = selectedIds.has(fullId) ? 'checked' : '';
                const lecturersHtml = cls.pengajar.length > 0 ? cls.pengajar.join('<br>') : '-';
                const roomHtml = cls.ruang.length > 0 ? cls.ruang.join(', ') : '-';
                html += `<div class="class-item"><input type="checkbox" id="${fullId}" data-class-id="${cls.nama_kelas}" data-course-id="${course.kode_mk}" ${isChecked}><label for="${fullId}" class="class-info"><strong>${cls.nama_kelas}</strong><span class="details">Jadwal: ${cls.jadwal.join(' | ')} <br> Ruang: ${roomHtml} <br> Pengajar: <br>${lecturersHtml}</span></label></div>`;
            });
            html += `</div>`;
        });
        courseListContainer.innerHTML = html;
        document.querySelectorAll('input[type="checkbox"]').forEach(c => c.addEventListener('change', handleClassSelection));
    }
    function renderListView(totalSKS) {
        listViewBody.innerHTML = '';
        if (selectedClasses.length === 0) {
            listViewBody.innerHTML = `<tr><td colspan="5" style="text-align:center;">Belum ada mata kuliah yang dipilih.</td></tr>`;
        } else {
            selectedClasses.forEach(cls => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${cls.nama_kelas}</td><td>${cls.jadwal.join('<br>')}</td><td>${cls.ruang.join('<br>')}</td><td>${cls.pengajar.join('<br>')}</td><td>${cls.sks || 0}</td>`;
                listViewBody.appendChild(row);
            });
        }
        listSksTotal.textContent = totalSKS;
    }
    function renderCalendarView() {
        timetableElement.innerHTML = '';
        const days = ["Jam", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
        days.forEach(day => { timetableElement.innerHTML += `<div class="grid-header">${day}</div>`; });
        const startHour = 7, endHour = 19;
        for (let i = 0; i < (endHour - startHour) * 2; i++) {
            const row = i + 2;
            const hour = startHour + Math.floor(i / 2);
            const minute = (i % 2 === 0) ? '00' : '30';
            timetableElement.innerHTML += `<div class="time-slot" style="grid-row: ${row}; grid-column: 1;">${hour.toString().padStart(2, '0')}.${minute}</div>`;
            timetableElement.innerHTML += `<div class="time-separator" style="grid-row: ${row};"></div>`;
        }
        const dayToGridColumn = { "Senin": 2, "Selasa": 3, "Rabu": 4, "Kamis": 5, "Jumat": 6, "Sabtu": 7 };
        selectedClasses.forEach(cls => {
            cls.jadwal.forEach(scheduleStr => {
                const [hari, waktu] = scheduleStr.split(', ');
                const [mulaiStr, selesaiStr] = waktu.split('-');
                const startMinutes = timeToMinutes(mulaiStr);
                const endMinutes = timeToMinutes(selesaiStr);
                const startRow = Math.floor((startMinutes - startHour * 60) / 30) + 2;
                const endRow = Math.ceil((endMinutes - startHour * 60) / 30) + 2;
                const column = dayToGridColumn[hari];
                if(column && startRow >=2 && endRow > startRow) {
                    const block = document.createElement('div');
                    block.className = 'schedule-block';
                    block.style.gridColumn = `${column}`;
                    block.style.gridRow = `${startRow} / ${endRow}`;
                    block.innerHTML = `<div class="block-time">${mulaiStr} - ${selesaiStr}</div><div class="block-classname">${cls.nama_kelas}</div><div class="block-room">Ruang: ${cls.ruang.join(', ')}</div>`;
                    timetableElement.appendChild(block);
                }
            });
        });
    }

    fetch('jadwal.json')
        .then(response => response.ok ? response.json() : Promise.reject(response.statusText))
        .then(data => {
            courseData = data;
            renderCourseList();
            updateAllUI();
        })
        .catch(error => {
            console.error('Gagal memuat JSON:', error);
            courseListContainer.innerHTML = `<p>Error: Gagal memuat file <strong>jadwal.json</strong>.</p>`;
        });
});
</script>
</body>
</html>
